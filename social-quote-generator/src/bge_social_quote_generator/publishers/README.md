# Publishers Module

This module contains social media publishers for the BGE Social Quote Generator.

## Overview

Publishers are responsible for posting generated quote images to social media platforms. Each publisher implements the `BasePublisher` interface and handles platform-specific authentication, image upload, and posting logic.

## Architecture

```
publishers/
â”œâ”€â”€ __init__.py              # Package exports
â”œâ”€â”€ base.py                  # Base publisher interface
â”œâ”€â”€ twitter_publisher.py     # Twitter/X implementation
â””â”€â”€ README.md               # This file
```

## Base Publisher Interface

All publishers inherit from `BasePublisher` and must implement:

- `_get_platform_name()`: Return platform identifier (e.g., "twitter")
- `authenticate()`: Authenticate with platform API
- `publish(image_path, quote_data, dry_run)`: Publish image with caption

### PublishResult

All publish operations return a `PublishResult` dataclass:

```python
@dataclass
class PublishResult:
    success: bool              # Whether publish succeeded
    platform: str              # Platform name
    post_url: Optional[str]    # URL of published post
    error: Optional[str]       # Error message if failed
    timestamp: datetime        # When operation completed
```

## Available Publishers

### TwitterPublisher

Publishes to Twitter/X using the tweepy library.

**Features:**
- OAuth 1.0a authentication
- Media upload via API v1.1
- Tweet creation via API v2
- Automatic retry with exponential backoff
- Caption length validation (280 chars)
- Dry-run mode support

**Configuration:**
```yaml
social_media:
  twitter:
    enabled: true
    api_key: "${TWITTER_API_KEY}"
    api_secret: "${TWITTER_API_SECRET}"
    access_token: "${TWITTER_ACCESS_TOKEN}"
    access_token_secret: "${TWITTER_ACCESS_TOKEN_SECRET}"
    caption_template: "ðŸŽ™ï¸ BGE Episodio {episode_number}: {title}\n\n{quote}\n\n{hashtags}\n\nðŸ”— {youtube_url}"
    hashtags: ["#BGE", "#DevOps", "#IT", "#Tech"]
```

**Usage:**
```python
from src.config import Config
from src.publishers.twitter_publisher import TwitterPublisher

config = Config("config/config.yaml")
publisher = TwitterPublisher(config)
publisher.authenticate()

result = publisher.publish(
    image_path="output/images/bge_42_twitter.png",
    quote_data=episode_data,
    dry_run=False
)

if result.success:
    print(f"Published: {result.post_url}")
else:
    print(f"Failed: {result.error}")
```

## Caption Templates

Caption templates support the following variables:

- `{episode_number}`: Episode number (e.g., "42")
- `{title}`: Episode title without number (from `titolo` field)
- `{quote}`: Selected quote text
- `{guests}`: Comma-separated guest names
- `{date}`: Publication date (YYYY-MM-DD)
- `{youtube_url}`: Full YouTube URL
- `{youtube_id}`: YouTube video ID
- `{host}`: Host name
- `{hashtags}`: Generated hashtags string

## Hashtag Generation

Hashtags are generated by combining:
1. Platform default hashtags (from config)
2. Episode-specific tags (from episode data)

Tags are automatically formatted with `#` prefix and spaces removed.

## Error Handling

Publishers implement comprehensive error handling:

- **Authentication errors**: Clear messages about missing/invalid credentials
- **File errors**: Validation that image exists and is readable
- **API errors**: Retry logic for transient errors (rate limits, server errors)
- **Network errors**: Automatic retry with exponential backoff

### Retry Logic

Uses the `tenacity` library for retry behavior:
- **Retry on**: Rate limits, server errors
- **Stop after**: 3 attempts
- **Wait strategy**: Exponential backoff (1s, 2s, 4s, 8s, 10s max)
- **Logging**: Logs each retry attempt

## Dry-Run Mode

All publishers support dry-run mode:
```python
result = publisher.publish(
    image_path="path/to/image.png",
    quote_data=episode_data,
    dry_run=True  # Generate caption but don't publish
)
```

In dry-run mode:
- Caption is generated and logged
- Image validation is skipped
- No API calls are made
- Returns success with placeholder URL

## Adding New Publishers

To add a new platform publisher:

1. Create a new file: `src/publishers/[platform]_publisher.py`
2. Inherit from `BasePublisher`
3. Implement required methods:
   ```python
   class NewPlatformPublisher(BasePublisher):
       def _get_platform_name(self) -> str:
           return "newplatform"
       
       def authenticate(self) -> bool:
           # Implement authentication
           pass
       
       def publish(self, image_path, quote_data, dry_run) -> PublishResult:
           # Implement publishing
           pass
   ```
4. Add configuration to `config.yaml`
5. Export from `__init__.py`
6. Add tests

## Testing

Test publishers using the test script:
```bash
python test_twitter_publisher.py
```

Tests cover:
- Caption generation
- Hashtag generation
- Credential validation
- Dry-run publishing
- Error handling

## Dependencies

- `tweepy>=4.14.0`: Twitter API client
- `tenacity>=8.2.0`: Retry logic
- `python-dotenv>=1.0.0`: Environment variables

## Future Publishers

Planned implementations:
- InstagramPublisher (using instagrapi)
- FacebookPublisher (using facebook-sdk)
- LinkedInPublisher (using linkedin-api)

## Security Notes

- Never commit API credentials to version control
- Use environment variables or `.env` file for credentials
- Add `.env` to `.gitignore`
- Use read-only API permissions where possible
- Validate all file paths to prevent directory traversal
- Sanitize text input before rendering

## Logging

Publishers use Python's logging module:
```python
import logging
logger = logging.getLogger(__name__)
```

Log levels:
- **DEBUG**: Detailed operation info (media IDs, API responses)
- **INFO**: Normal operations (authentication, publish success)
- **WARNING**: Non-fatal issues (caption truncation, retries)
- **ERROR**: Failures (authentication errors, API errors)
